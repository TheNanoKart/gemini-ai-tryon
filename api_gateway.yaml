# api_gateway.yaml

# This OpenAPI 2.0 specification defines your API Gateway configuration.
# It exposes the /api/tryon endpoint, configures API key authentication,
# and sets up rate limiting.

swagger: '2.0'
info:
  title: Gemini Try-On API
  description: API Gateway for the Gemini Try-On application deployed on Cloud Run.
  version: 1.0.0
host: 'YOUR_GATEWAY_HOSTNAME' # This will be generated by API Gateway upon deployment.
                              # You'll replace this placeholder after deployment.
schemes:
  - https

# Define the paths for your API
paths:
  /api/tryon:
    post: # The endpoint handles POST requests
      summary: Perform a virtual try-on with Gemini AI.
      operationId: tryOn
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: body
          description: User image and clothing image data for try-on.
          required: true
          schema:
            type: object
            properties:
              user_image:
                type: string
                format: byte # Base64 encoded image
                description: Base64 encoded user image.
              clothing_image:
                type: string
                format: byte # Base64 encoded image
                description: Base64 encoded clothing image.
              prompt:
                type: string
                description: Optional prompt for Gemini model.
      responses:
        '200':
          description: Successful try-on response.
          schema:
            type: object
            properties:
              result:
                type: string
                description: The generated try-on image (base64 encoded).
        '400':
          description: Bad request (e.g., missing images).
        '500':
          description: Internal server error.
      security:
        # This requires an API key for this specific endpoint.
        # The key must be passed in the 'x-api-key' header or as an 'key' query parameter.
        - api_key: []
      x-google-backend:
        # Specifies the Cloud Run service that this endpoint will call.
        # Replace YOUR_CLOUD_RUN_SERVICE_URL with the actual URL of your deployed Cloud Run service.
        # You can get this from the Cloud Run console after your service is deployed.
        address: 'YOUR_CLOUD_RUN_SERVICE_URL/api/tryon'
        protocol: h2 # Recommended for Cloud Run

# Security definitions for API keys
securityDefinitions:
  api_key:
    type: apiKey
    name: key # The query parameter name for the API key, or 'x-api-key' for header.
    in: query # Can be 'query' or 'header'

# Apply rate limiting
x-google-quota:
  limits:
    # A limit named 'requests' with a metric named 'api-gateway.googleapis.com/requests'
    # and a quota bucket size of 100 requests.
    - metric: 'api-gateway.googleapis.com/requests'
      unit: '1/{minute}' # The unit for the limit (e.g., 1 request per minute)
      # This example sets a limit of 60 requests per minute per API key.
      # Adjust 'value' as per your requirements.
      value: 60
  # Define the metrics that will be used for rate limiting.
  # This metric tracks general API requests.
  metrics:
    - name: 'api-gateway.googleapis.com/requests'
      displayName: 'Requests'
      valueExtractor: 'request.api_key' # This ensures that rate limiting is applied per API key.
